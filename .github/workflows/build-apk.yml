name: Build Android APK

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.0"
          channel: "stable"
          cache: true

      - name: Create firebase_options.dart
        run: |
          mkdir -p flutter_app/lib
          cat > flutter_app/lib/firebase_options.dart << 'EOF'
          // TODO: Replace with your Firebase config
          // Get from: flutterfire configure
          import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
          import 'package:flutter/foundation.dart' show defaultTargetPlatform, TargetPlatform;

          class DefaultFirebaseOptions {
            static FirebaseOptions get currentPlatform {
              switch (defaultTargetPlatform) {
                case TargetPlatform.android:
                  return android;
                case TargetPlatform.iOS:
                  return ios;
                default:
                  throw UnsupportedError('DefaultFirebaseOptions are not supported for this platform.');
              }
            }
            
            static const FirebaseOptions android = FirebaseOptions(
              apiKey: 'YOUR_API_KEY',
              appId: 'YOUR_APP_ID',
              messagingSenderId: 'YOUR_SENDER_ID',
              projectId: 'YOUR_PROJECT_ID',
              storageBucket: 'YOUR_BUCKET',
            );
            
            static const FirebaseOptions ios = FirebaseOptions(
              apiKey: 'YOUR_API_KEY',
              appId: 'YOUR_APP_ID',
              messagingSenderId: 'YOUR_SENDER_ID',
              projectId: 'YOUR_PROJECT_ID',
              storageBucket: 'YOUR_BUCKET',
              iosClientId: 'YOUR_IOS_CLIENT_ID',
              iosBundleId: 'YOUR_BUNDLE_ID',
            );
          }
          EOF

      - name: Create google-services.json
        run: |
          mkdir -p flutter_app/android/app
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > flutter_app/android/app/google-services.json

      - name: Install dependencies
        run: |
          cd flutter_app
          flutter pub get

      - name: Generate code
        run: |
          cd flutter_app
          flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build APK (Debug)
        if: github.event_name == 'pull_request'
        run: |
          cd flutter_app
          flutter build apk --debug

      - name: Build APK (Release)
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        run: |
          cd flutter_app
          flutter build apk --release

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kalorientracker-app
          path: |
            flutter_app/build/app/outputs/flutter-apk/app-release.apk
            flutter_app/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30
